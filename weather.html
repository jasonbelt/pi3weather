<html>
  <body>

    <input type="date" id="startDate" name="date-start"
           value="2023-06-20"
           min="2023-06-04" max="2023-06-23">

    <input type="date" id="endDate" name="date-end"
           value="2023-06-20"
           min="2023-06-04" max="2023-06-23">

    <select id="reading" name="reading">
      <option value="h" selected>Humidity</option>
      <option value="f">Fahrenheit</option>
      <option value="c">Celcius</option>
    </select>
    
    <div>
      <canvas id="myChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>

    <script>
      var xmlhttp = new XMLHttpRequest();

      var fulldata = null;
      var chart = null;
      
      function format(s) { return s.substring(5, 10) + ' ' +  s.substring(11, 16) }

      function displayData(startDate, endDate) {

          const fdata = fulldata.filter(f => f.d >= startDate && f.d <= endDate );

          const reading = document.getElementById('reading')
          const key = reading.value
          const dataLabel = reading.options[reading.selectedIndex].text;

          var minV = Number.MAX_SAFE_INTEGER;
          var maxV = Number.MIN_SAFE_INTEGER;

          const annotations = [];
          var last = 0;
          var buildBox = false;
          function makeBox(a, b) {
              annotations.push({
      	          id: 'box' + a,
                  type: 'box',
                  xMin: fdata[a].ds,
                  xMax: fdata[b].ds,
                  backgroundColor: 'rgba(100, 100, 100, 0.2)',
                  borderWidth: 0
              })
          }
          for (i = 0; i < fdata.length; i++) {
              if (fdata[i][key] - 1 < minV) minV = fdata[i][key] - 1;
              if (fdata[i][key] + 1 > maxV) maxV = fdata[i][key] + 1;

              if (fdata[last].d.getDay() != fdata[i].d.getDay() ) {
                  if (buildBox) {
                      makeBox(last, i - 1);
                  }
                  last = i;
                  buildBox = !buildBox;
              }
          }
          if (buildBox) {
              makeBox(last, fdata.length - 1);
          }

          const dates = fdata.map(d => d.ds);
          const data = fdata.map(d => d[key]);
          
          const ctx = document.getElementById('myChart').getContext('2d');
          if (chart != null) {
              chart.destroy();
          }
          
          chart = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: dates,
                  datasets: [{
                      label: dataLabel,
                      data: data,
                      backgroundColor: 'rgba(75, 192, 192, 0.2)',
                      borderColor: 'rgba(75, 192, 192, 1)',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  scales: {
                      y: {
                          min: minV,
                          max: maxV,
                      }
                  },
                  plugins: {
                      annotation: {
                          annotations: annotations
                      }
                  }
              }
          });
      }

      function redraw() {
          var sd = new Date(document.getElementById('startDate').value + "T00:00:00.000");
          var ed = new Date(document.getElementById('endDate').value + "T23:59:59.00");
          displayData(sd, ed);
      }
      
      document.getElementById('reading').addEventListener ("change", redraw);
      document.getElementById('startDate').addEventListener ("change", redraw);
      document.getElementById('endDate').addEventListener ("change", redraw);
      
      xmlhttp.onreadystatechange = function() {
          if(xmlhttp.status==200 && xmlhttp.readyState==4) {
              var d = xmlhttp.responseText
              
              data = JSON.parse('[' + d + ']');
              fulldata = data.map(dd => {
                  return {
                      // parse date and add a pretty-printed version
                      d : new Date(dd.d), ds : format(dd.d),
                      f : dd.f, c : dd.c, h : dd.h }
              })
              
              const sd = document.getElementById('startDate');
              const ed = document.getElementById('endDate');
              
              const minDate = fulldata[0].d
              const maxDate = fulldata.slice(-1)[0].d

              ed.value = maxDate.toISOString().split('T')[0];
              ed.min = minDate.toISOString().split('T')[0];
              ed.max = maxDate.toISOString().split('T')[0];
              
              sd.value = ed.value;
              sd.min = ed.min;
              sd.max = ed.max;

              displayData(new Date(maxDate).setHours(maxDate.getHours() - 24), maxDate);
          }
      }
      xmlhttp.open("GET","weather.json",true);
      xmlhttp.send();
    </script>
  </body>
</html>
